<!doctype html><html lang=zh-cn><head><title>嵌入式 Linux 外设 [Part 1] -- GPIO 与 I2C ::
Horizon Blog Neo</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="在香橙派 R1+ LTS 上使用 GPIO 与 I2C # 背景 # 之前买了一块儿 OrangePi R1 Plus LTS 作为软路由, 最近无聊时翻阅它的手册, 发现它自带了一些 GPIO, 其中包括一个 TWI/I2C, 一个 UART, 于是尝试利用"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://horizonchaser.github.io/neo/posts/opai-linux-gpio/><link rel=stylesheet href=/neo/css/style.css><link rel=stylesheet href=https://horizonchaser.github.io/neo/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://horizonchaser.github.io/neo/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://horizonchaser.github.io/neo/img/favicon.png><link href=/neo/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/neo/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/neo/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/neo/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/neo/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/neo/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="嵌入式 Linux 外设 [Part 1] -- GPIO 与 I2C"><meta name=twitter:description content="之前搞了个 OrangePi R1 Plus LTS 作为软路由, 但是它也有一些标准的外部接口, 所以试着在 Linux 上操作它们吧"><meta property="og:title" content="嵌入式 Linux 外设 [Part 1] -- GPIO 与 I2C"><meta property="og:description" content="之前搞了个 OrangePi R1 Plus LTS 作为软路由, 但是它也有一些标准的外部接口, 所以试着在 Linux 上操作它们吧"><meta property="og:type" content="article"><meta property="og:url" content="https://horizonchaser.github.io/neo/posts/opai-linux-gpio/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-11T11:49:18+08:00"><meta property="article:modified_time" content="2024-01-12T23:24:45+08:00"><meta property="og:site_name" content="Horizon Blog Neo"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/neo class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>Horizon Blog Neo</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/neo/index.xml>RSS</a></li><li><a href=/neo/about/>关于</a></li><li><a href=/neo/links/>友链</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/neo/index.xml>RSS</a></li><li><a href=/neo/about/>关于</a></li><li><a href=/neo/links/>友链</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><article class=post><h1 class=post-title>嵌入式 Linux 外设 [Part 1] &ndash; GPIO 与 I2C</h1><div class=post-meta><time class=post-date>2024-01-11</time>
<span class=post-moddate>(最后修改于：
2024-01-12)</span></div><span class=post-tags><a href=https://horizonchaser.github.io/neo/tags/orangepi/>#OrangePi</a>&nbsp;
<a href=https://horizonchaser.github.io/neo/tags/linux/>#Linux</a>&nbsp;
<a href=https://horizonchaser.github.io/neo/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/>#嵌入式</a>&nbsp;
<a href=https://horizonchaser.github.io/neo/tags/i2c/>#I2C</a>&nbsp;</span><div class=post-content><h1 id=在香橙派-r1-lts-上使用-gpio-与-i2c>在香橙派 R1+ LTS 上使用 GPIO 与 I2C
<a href=#%e5%9c%a8%e9%a6%99%e6%a9%99%e6%b4%be-r1-lts-%e4%b8%8a%e4%bd%bf%e7%94%a8-gpio-%e4%b8%8e-i2c class=h-anchor aria-hidden=true>#</a></h1><h2 id=背景>背景
<a href=#%e8%83%8c%e6%99%af class=h-anchor aria-hidden=true>#</a></h2><p>之前买了一块儿 OrangePi R1 Plus LTS 作为软路由, 最近无聊时翻阅它的手册, 发现它自带了一些 GPIO, 其中包括一个 TWI/I2C, 一个 UART, 于是尝试利用这些接口增加一些外设, 比如在显示屏上显示系统状态与 IP 地址, 以及控制风扇转速等. 由于之前没有在 Linux 下搞过这些东西 (只在真 · 单片机上做过), 于是正好学习在 Linux 下操作外设的方法.</p><h2 id=在-armbian-中启用-i2c>在 Armbian 中启用 I2C
<a href=#%e5%9c%a8-armbian-%e4%b8%ad%e5%90%af%e7%94%a8-i2c class=h-anchor aria-hidden=true>#</a></h2><p>和官方手册略有不同的是, 在 Armbian 中启用 I2C 时对应的设备名不同. 不过我们也不需要手动添加, 在 <code>armbian-config</code> 的 <code>System > Hardware</code> 里面找到 <code>rk3328-i2c0</code>, 启用即可. 这实际上就是在 <code>/boot/armbianEnv.txt</code> 中增加一行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>overlays=rk3328-i2c0
</span></span></code></pre></div><p>和手册上的名字不一样, 所以直接添加上面这行也行. 重启之后应当能看见 <code>/dev/i2c-0</code></p><h2 id=编译-wiringop>编译 WiringOP
<a href=#%e7%bc%96%e8%af%91-wiringop class=h-anchor aria-hidden=true>#</a></h2><p>WiringOP 就是板子开发商 Xunlong 给自家的 OrangePi 适配的 WiringPi. 这里没有什么不同, 直接按照手册下载编译即可:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/orangepi-xunlong/wiringOP
</span></span><span style=display:flex><span>cd wiringOP
</span></span><span style=display:flex><span>./build clean
</span></span><span style=display:flex><span>./build 
</span></span></code></pre></div><h2 id=确认-i2c-是否启用>确认 I2C 是否启用
<a href=#%e7%a1%ae%e8%ae%a4-i2c-%e6%98%af%e5%90%a6%e5%90%af%e7%94%a8 class=h-anchor aria-hidden=true>#</a></h2><p>将 I2C 设备接上, 板子的 13 Pin 接口从网口侧数, 定义分别如下:</p><blockquote><p>VCC GND SDA SCL(SCK)</p></blockquote><p>之后运行 <code>sudo i2cdetect -y 0</code>, 理论上应当能看到连接的设备地址. 例如对于地址为 <code>0x77</code> 的 BMP180 来说, 应当是这样的:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>horizon@horizonpi-r1plus-lts:~$ sudo i2cdetect -y <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>     <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>2</span>  <span style=color:#ae81ff>3</span>  <span style=color:#ae81ff>4</span>  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>6</span>  <span style=color:#ae81ff>7</span>  <span style=color:#ae81ff>8</span>  <span style=color:#ae81ff>9</span>  a  b  c  d  e  f
</span></span><span style=display:flex><span>00:                         -- -- -- -- -- -- -- --
</span></span><span style=display:flex><span>10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
</span></span><span style=display:flex><span>20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
</span></span><span style=display:flex><span>30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
</span></span><span style=display:flex><span>40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
</span></span><span style=display:flex><span>50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
</span></span><span style=display:flex><span>60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
</span></span><span style=display:flex><span>70: -- -- -- -- -- -- -- <span style=color:#ae81ff>77</span>
</span></span></code></pre></div><p><strong>如果你看到的是在 <code>0x18</code> 的位置上有 <code>UU</code>, 说明你选择了错误的 I2C 接口, 或者没有正确启用 I2C (对于这块板子, 你应当能在 <code>/dev/</code> 下看到两个 I2C 设备, 但只有 0 号是可使用的).</strong></p><p>或者, 此时运行 <code>gpio readall</code> (<strong>先编译 WiringOP !</strong>), 应该看到如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>horizon@horizonpi-r1plus-lts:~$ gpio readall
</span></span><span style=display:flex><span> +------+-----+----------+--------+---+  R1 Plus +---+--------+----------+-----+------+
</span></span><span style=display:flex><span> | GPIO | wPi |   Name   |  Mode  | V | Physical | V |  Mode  | Name     | wPi | GPIO |
</span></span><span style=display:flex><span> +------+-----+----------+--------+---+----++----+---+--------+----------+-----+------+
</span></span><span style=display:flex><span> |      |     | 5V       |        |   |  <span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>2</span>  |   |        | GND      |     |      |
</span></span><span style=display:flex><span> |   <span style=color:#ae81ff>89</span> |   <span style=color:#ae81ff>0</span> | SDA.0    |   ALT2 | <span style=color:#ae81ff>1</span> |  <span style=color:#ae81ff>3</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>4</span>  | <span style=color:#ae81ff>1</span> | ALT2   | SCK.0    | <span style=color:#ae81ff>1</span>   | <span style=color:#ae81ff>88</span>   |
</span></span><span style=display:flex><span> |  <span style=color:#ae81ff>100</span> |   <span style=color:#ae81ff>2</span> | TXD.1    |   ALT5 | <span style=color:#ae81ff>1</span> |  <span style=color:#ae81ff>5</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>6</span>  | <span style=color:#ae81ff>1</span> | ALT5   | RXD.1    | <span style=color:#ae81ff>3</span>   | <span style=color:#ae81ff>102</span>  |
</span></span><span style=display:flex><span> |      |     |          |        |   |  <span style=color:#ae81ff>7</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>8</span>  |   |        |          |     |      |
</span></span><span style=display:flex><span> |      |     |          |        |   |  <span style=color:#ae81ff>9</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>10</span> | <span style=color:#ae81ff>1</span> | ALT3   | GPIO3_C0 | <span style=color:#ae81ff>4</span>   | <span style=color:#ae81ff>112</span>  |
</span></span><span style=display:flex><span> |  <span style=color:#ae81ff>103</span> |   <span style=color:#ae81ff>5</span> | CTS.1    |   ALT5 | <span style=color:#ae81ff>1</span> | <span style=color:#ae81ff>11</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>12</span> | <span style=color:#ae81ff>1</span> | ALT5   | RTS.1    | <span style=color:#ae81ff>6</span>   | <span style=color:#ae81ff>101</span>  |
</span></span><span style=display:flex><span> |   <span style=color:#ae81ff>66</span> |   <span style=color:#ae81ff>7</span> | GPIO2_A2 |     IN | <span style=color:#ae81ff>1</span> | <span style=color:#ae81ff>13</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>14</span> |   |        |          |     |      |
</span></span><span style=display:flex><span> +------+-----+----------+--------+---+----++----+---+--------+----------+-----+------+
</span></span><span style=display:flex><span> | GPIO | wPi |   Name   |  Mode  | V | Physical | V |  Mode  | Name     | wPi | GPIO |
</span></span><span style=display:flex><span> +------+-----+----------+--------+---+  R1 Plus +---+--------+----------+-----+------+
</span></span></code></pre></div><p>Pin 3 和 4 应当在 <code>ALT2</code> 模式下, 如果是 <code>IN</code> 说明没有启用 I2C, 它们只能当作普通的 GPIO 使用.</p><h2 id=读取-i2c-设备-bmp180>读取 I2C 设备 (BMP180)
<a href=#%e8%af%bb%e5%8f%96-i2c-%e8%ae%be%e5%a4%87-bmp180 class=h-anchor aria-hidden=true>#</a></h2><p>使用 Python 读取 BMP180 气压传感器, 先安装 <code>smbus</code> 库, 之后代码如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/python3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> smbus
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> math
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>address <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x77</span>  <span style=color:#75715e>#I2c device BMP180</span>
</span></span><span style=display:flex><span>mode <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> <span style=color:#75715e># mode Standard</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># BMP180 registers</span>
</span></span><span style=display:flex><span>CONTROL_REG <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xF4</span>
</span></span><span style=display:flex><span>DATA_REG <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xF6</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Calibration data registers</span>
</span></span><span style=display:flex><span>CAL_AC1_REG <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xAA</span>
</span></span><span style=display:flex><span>CAL_AC2_REG <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xAC</span>
</span></span><span style=display:flex><span>CAL_AC3_REG <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xAE</span>
</span></span><span style=display:flex><span>CAL_AC4_REG <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xB0</span>
</span></span><span style=display:flex><span>CAL_AC5_REG <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xB2</span>
</span></span><span style=display:flex><span>CAL_AC6_REG <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xB4</span>
</span></span><span style=display:flex><span>CAL_B1_REG <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xB6</span>
</span></span><span style=display:flex><span>CAL_B2_REG <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xB8</span>
</span></span><span style=display:flex><span>CAL_MB_REG <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xBA</span>
</span></span><span style=display:flex><span>CAL_MC_REG <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xBC</span>
</span></span><span style=display:flex><span>CAL_MD_REG <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xBE</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_signed_16_bit</span>( register): <span style=color:#75715e>#Lit valeur signée 16 bits</span>
</span></span><span style=display:flex><span>        msb <span style=color:#f92672>=</span> bus<span style=color:#f92672>.</span>read_byte_data(address, register)
</span></span><span style=display:flex><span>        lsb <span style=color:#f92672>=</span> bus<span style=color:#f92672>.</span>read_byte_data(address, register <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> msb <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>127</span>:
</span></span><span style=display:flex><span>            msb <span style=color:#f92672>-=</span> <span style=color:#ae81ff>256</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (msb <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>8</span>) <span style=color:#f92672>+</span> lsb
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_unsigned_16_bit</span>( register):  <span style=color:#75715e>#Lit valeur non signée 16 bits</span>
</span></span><span style=display:flex><span>        msb <span style=color:#f92672>=</span> bus<span style=color:#f92672>.</span>read_byte_data(address, register)
</span></span><span style=display:flex><span>        lsb <span style=color:#f92672>=</span> bus<span style=color:#f92672>.</span>read_byte_data(address, register <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (msb <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>8</span>) <span style=color:#f92672>+</span> lsb
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Temperature (see BMP180 datasheet)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_raw_temp</span>():
</span></span><span style=display:flex><span>        <span style=color:#75715e># Start the measurement</span>
</span></span><span style=display:flex><span>        bus<span style=color:#f92672>.</span>write_byte_data(address, CONTROL_REG, <span style=color:#ae81ff>0x2E</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e># Wait 5 ms</span>
</span></span><span style=display:flex><span>        time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>0.005</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e># Read the raw data from the DATA_REG, 0xF6</span>
</span></span><span style=display:flex><span>        raw_data <span style=color:#f92672>=</span> read_unsigned_16_bit(DATA_REG)
</span></span><span style=display:flex><span>        <span style=color:#75715e># Return the raw data</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> raw_data
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_temp</span>():
</span></span><span style=display:flex><span>        UT <span style=color:#f92672>=</span> get_raw_temp()
</span></span><span style=display:flex><span>        X1 <span style=color:#f92672>=</span> ((UT <span style=color:#f92672>-</span> calAC6) <span style=color:#f92672>*</span> calAC5) <span style=color:#f92672>/</span> math<span style=color:#f92672>.</span>pow(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>15</span>)
</span></span><span style=display:flex><span>        X2 <span style=color:#f92672>=</span> calMC<span style=color:#f92672>*</span>math<span style=color:#f92672>.</span>pow(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>11</span>)<span style=color:#f92672>/</span>(X1<span style=color:#f92672>+</span>calMD)
</span></span><span style=display:flex><span>        B5 <span style=color:#f92672>=</span> X1 <span style=color:#f92672>+</span> X2
</span></span><span style=display:flex><span>        temperature <span style=color:#f92672>=</span> ((B5 <span style=color:#f92672>+</span> <span style=color:#ae81ff>8</span>) <span style=color:#f92672>/</span> math<span style=color:#f92672>.</span>pow(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>4</span>)) <span style=color:#f92672>/</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> temperature
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Pressure</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_raw_pressure</span>():
</span></span><span style=display:flex><span>        bus<span style=color:#f92672>.</span>write_byte_data(address, CONTROL_REG, <span style=color:#ae81ff>0x34</span> <span style=color:#f92672>+</span> (mode <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>6</span>))
</span></span><span style=display:flex><span>        <span style=color:#75715e># Sleep for 8 ms.</span>
</span></span><span style=display:flex><span>        time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>0.008</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e># Read the raw data from the DATA_REG, 0xF6</span>
</span></span><span style=display:flex><span>        MSB <span style=color:#f92672>=</span> bus<span style=color:#f92672>.</span>read_byte_data(address, DATA_REG)
</span></span><span style=display:flex><span>        LSB <span style=color:#f92672>=</span> bus<span style=color:#f92672>.</span>read_byte_data(address, DATA_REG <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        XLSB <span style=color:#f92672>=</span> bus<span style=color:#f92672>.</span>read_byte_data(address, DATA_REG <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>        raw_data <span style=color:#f92672>=</span> ((MSB <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>16</span>) <span style=color:#f92672>+</span> (LSB <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>8</span>) <span style=color:#f92672>+</span> XLSB) <span style=color:#f92672>&gt;&gt;</span> (<span style=color:#ae81ff>8</span> <span style=color:#f92672>-</span> mode)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> raw_data
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_pressure</span>():
</span></span><span style=display:flex><span>        UP <span style=color:#f92672>=</span> get_raw_pressure()
</span></span><span style=display:flex><span>        UT <span style=color:#f92672>=</span> get_raw_temp()
</span></span><span style=display:flex><span>        <span style=color:#75715e>#calculation idem temperature</span>
</span></span><span style=display:flex><span>        X1 <span style=color:#f92672>=</span> ((UT <span style=color:#f92672>-</span> calAC6) <span style=color:#f92672>*</span> calAC5) <span style=color:#f92672>/</span> math<span style=color:#f92672>.</span>pow(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>15</span>)
</span></span><span style=display:flex><span>        X2 <span style=color:#f92672>=</span> (calMC <span style=color:#f92672>*</span> math<span style=color:#f92672>.</span>pow(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>11</span>)) <span style=color:#f92672>/</span> (X1 <span style=color:#f92672>+</span> calMD)
</span></span><span style=display:flex><span>        B5 <span style=color:#f92672>=</span> X1 <span style=color:#f92672>+</span> X2
</span></span><span style=display:flex><span>        B6 <span style=color:#f92672>=</span> B5 <span style=color:#f92672>-</span> <span style=color:#ae81ff>4000</span>
</span></span><span style=display:flex><span>        X1 <span style=color:#f92672>=</span> (calB2 <span style=color:#f92672>*</span> (B6 <span style=color:#f92672>*</span> B6 <span style=color:#f92672>/</span> math<span style=color:#f92672>.</span>pow(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>12</span>))) <span style=color:#f92672>/</span> math<span style=color:#f92672>.</span>pow(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>11</span>)
</span></span><span style=display:flex><span>        X2 <span style=color:#f92672>=</span> calAC2 <span style=color:#f92672>*</span> B6 <span style=color:#f92672>/</span> math<span style=color:#f92672>.</span>pow(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>11</span>)
</span></span><span style=display:flex><span>        X3 <span style=color:#f92672>=</span> X1 <span style=color:#f92672>+</span> X2
</span></span><span style=display:flex><span>        B3 <span style=color:#f92672>=</span> (((calAC1 <span style=color:#f92672>*</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>+</span> int(X3)) <span style=color:#f92672>&lt;&lt;</span> mode) <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>) <span style=color:#f92672>/</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>        X1 <span style=color:#f92672>=</span> calAC3 <span style=color:#f92672>*</span> B6 <span style=color:#f92672>/</span> math<span style=color:#f92672>.</span>pow(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>13</span>)
</span></span><span style=display:flex><span>        X2 <span style=color:#f92672>=</span> (calB1 <span style=color:#f92672>*</span> (B6 <span style=color:#f92672>*</span> B6 <span style=color:#f92672>/</span> math<span style=color:#f92672>.</span>pow(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>12</span>))) <span style=color:#f92672>/</span> math<span style=color:#f92672>.</span>pow(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>        X3 <span style=color:#f92672>=</span> ((X1 <span style=color:#f92672>+</span> X2) <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>) <span style=color:#f92672>/</span> math<span style=color:#f92672>.</span>pow(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>        B4 <span style=color:#f92672>=</span> calAC4 <span style=color:#f92672>*</span> (X3 <span style=color:#f92672>+</span> <span style=color:#ae81ff>32768</span>) <span style=color:#f92672>/</span> math<span style=color:#f92672>.</span>pow(<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>15</span>)
</span></span><span style=display:flex><span>        B7 <span style=color:#f92672>=</span> (UP <span style=color:#f92672>-</span> B3) <span style=color:#f92672>*</span> (<span style=color:#ae81ff>50000</span> <span style=color:#f92672>&gt;&gt;</span> mode)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> B7 <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0x80000000</span>:
</span></span><span style=display:flex><span>            pressure <span style=color:#f92672>=</span> (B7 <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>) <span style=color:#f92672>/</span> B4
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            pressure <span style=color:#f92672>=</span> (B7 <span style=color:#f92672>/</span> B4) <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>        X1 <span style=color:#f92672>=</span> (pressure <span style=color:#f92672>/</span> math<span style=color:#f92672>.</span>pow(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>8</span>)) <span style=color:#f92672>*</span> (pressure <span style=color:#f92672>/</span> math<span style=color:#f92672>.</span>pow(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>8</span>))
</span></span><span style=display:flex><span>        X1 <span style=color:#f92672>=</span> (X1 <span style=color:#f92672>*</span> <span style=color:#ae81ff>3038</span>) <span style=color:#f92672>/</span> math<span style=color:#f92672>.</span>pow(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>        X2 <span style=color:#f92672>=</span> (<span style=color:#f92672>-</span><span style=color:#ae81ff>7357</span> <span style=color:#f92672>*</span> pressure) <span style=color:#f92672>/</span> math<span style=color:#f92672>.</span>pow(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>        pressure <span style=color:#f92672>=</span> pressure <span style=color:#f92672>+</span> (X1 <span style=color:#f92672>+</span> X2 <span style=color:#f92672>+</span> <span style=color:#ae81ff>3791</span>) <span style=color:#f92672>/</span> math<span style=color:#f92672>.</span>pow(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>        pressure<span style=color:#f92672>=</span>pressure<span style=color:#f92672>/</span><span style=color:#ae81ff>100</span> <span style=color:#75715e>#hPa</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> pressure
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># I2C bus 0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>bus <span style=color:#f92672>=</span> smbus<span style=color:#f92672>.</span>SMBus(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Calibration data variables</span>
</span></span><span style=display:flex><span>calAC1 <span style=color:#f92672>=</span> read_signed_16_bit(CAL_AC1_REG)
</span></span><span style=display:flex><span>calAC2 <span style=color:#f92672>=</span> read_signed_16_bit(CAL_AC2_REG)
</span></span><span style=display:flex><span>calAC3 <span style=color:#f92672>=</span> read_signed_16_bit(CAL_AC3_REG)
</span></span><span style=display:flex><span>calAC4 <span style=color:#f92672>=</span> read_unsigned_16_bit(CAL_AC4_REG)
</span></span><span style=display:flex><span>calAC5 <span style=color:#f92672>=</span> read_unsigned_16_bit(CAL_AC5_REG)
</span></span><span style=display:flex><span>calAC6 <span style=color:#f92672>=</span> read_unsigned_16_bit(CAL_AC6_REG)
</span></span><span style=display:flex><span>calB1 <span style=color:#f92672>=</span> read_signed_16_bit(CAL_B1_REG)
</span></span><span style=display:flex><span>calB2 <span style=color:#f92672>=</span> read_signed_16_bit(CAL_B2_REG)
</span></span><span style=display:flex><span>calMB <span style=color:#f92672>=</span> read_signed_16_bit(CAL_MB_REG)
</span></span><span style=display:flex><span>calMC <span style=color:#f92672>=</span> read_signed_16_bit(CAL_MC_REG)
</span></span><span style=display:flex><span>calMD <span style=color:#f92672>=</span> read_signed_16_bit(CAL_MD_REG)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;Calibration:&#34;</span>,calAC1,calAC2,calAC3,calAC4,calAC5,calAC6,calB1,calB2,calMB,calMC,calMD)
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;Temperature: </span><span style=color:#e6db74>{0:0.1f}</span><span style=color:#e6db74> C&#34;</span><span style=color:#f92672>.</span>format(get_temp()))
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;Pressure = </span><span style=color:#e6db74>{0:0.1f}</span><span style=color:#e6db74> hPa&#39;</span><span style=color:#f92672>.</span>format(get_pressure()))
</span></span><span style=display:flex><span>    time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>0.5</span>)
</span></span></code></pre></div><p>代码来自 <a href=https://f1atb.fr/index.php/2020/10/04/bmp180-and-orange-pi-zero/>这里</a>. 虽然很长, 但大部分内容都是在处理 BMP180 给出的数据; 从 I2C 读数据只有很少一点. 如果没啥问题, 应该是这样的</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>horizon@horizonpi-r1plus-lts:~$ sudo python3 bmp.py
</span></span><span style=display:flex><span>Calibration: <span style=color:#ae81ff>9096</span> -1237 -14304 <span style=color:#ae81ff>34330</span> <span style=color:#ae81ff>25663</span> <span style=color:#ae81ff>16155</span> <span style=color:#ae81ff>6515</span> <span style=color:#ae81ff>51</span> -32768 -11786 <span style=color:#ae81ff>2416</span>
</span></span><span style=display:flex><span>Temperature: 26.3 C
</span></span><span style=display:flex><span>Pressure <span style=color:#f92672>=</span> 1008.0 hPa
</span></span><span style=display:flex><span>Temperature: 26.2 C
</span></span><span style=display:flex><span>Pressure <span style=color:#f92672>=</span> 1007.9 hPa
</span></span><span style=display:flex><span>Temperature: 26.2 C
</span></span><span style=display:flex><span>Pressure <span style=color:#f92672>=</span> 1007.9 hPa
</span></span><span style=display:flex><span>.........
</span></span></code></pre></div><p>第一行是 BMP180 的校准数据, 后面是获取到的温度和气压. 通过 I2C 接口也可以操作其他设备, 等我买的显示屏到了再继续吧.</p><h2 id=关于-armbian-和-orangepi-的不算彩蛋的彩蛋>关于 Armbian 和 OrangePi 的不算彩蛋的彩蛋
<a href=#%e5%85%b3%e4%ba%8e-armbian-%e5%92%8c-orangepi-%e7%9a%84%e4%b8%8d%e7%ae%97%e5%bd%a9%e8%9b%8b%e7%9a%84%e5%bd%a9%e8%9b%8b class=h-anchor aria-hidden=true>#</a></h2><p>通过 SSH 连接到板子时, motd 会包含板子型号的 <a href=https://en.wikipedia.org/wiki/ASCII_art>ASCII ART</a>, 也就是字符画. 由于空间有限, 一些词会缩写, 所以就会&mldr;这样&mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>❯ ssh horizon@192.168.1.9
</span></span><span style=display:flex><span>  ___  ____  _   ____  _   ____  _             _   _____ ____
</span></span><span style=display:flex><span> / _ <span style=color:#ae81ff>\|</span>  _ <span style=color:#ae81ff>\(</span>_<span style=color:#f92672>)</span> |  _ <span style=color:#ae81ff>\/</span> | |  _ <span style=color:#ae81ff>\|</span> |_   _ ___  | | |_   _/ ___|
</span></span><span style=display:flex><span>| | | | |_<span style=color:#f92672>)</span> | | | |_<span style=color:#f92672>)</span> | | | |_<span style=color:#f92672>)</span> | | | | / __| | |   | | <span style=color:#ae81ff>\_</span>__ <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>| |_| |  __/| | |  _ &lt;| | |  __/| | |_| <span style=color:#ae81ff>\_</span>_ <span style=color:#ae81ff>\ </span>| |___| |  ___<span style=color:#f92672>)</span> |
</span></span><span style=display:flex><span> <span style=color:#ae81ff>\_</span>__/|_|   |_| |_| <span style=color:#ae81ff>\_\_</span>| |_|   |_|<span style=color:#ae81ff>\_</span>_,_|___/ |_____|_| |____/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Welcome to Armbian 23.11.1 Bookworm with Linux 6.1.63-current-rockchip64
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>System load:   2%               Up time:       <span style=color:#ae81ff>26</span> min
</span></span><span style=display:flex><span>Memory usage:  18% of 976M      IP:            <span style=color:#f92672>[</span>DELETED<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>CPU temp:      50°C             Usage of /:    4% of 58G
</span></span><span style=display:flex><span>RX today:      133.1 KiB
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Last login: Wed Jan <span style=color:#ae81ff>10</span> 23:08:51 <span style=color:#ae81ff>2024</span> from <span style=color:#f92672>[</span>DELETED<span style=color:#f92672>]</span>
</span></span></code></pre></div><p><code>OrangePi</code> 会被缩写成 <code>OPi</code>&mldr;. 负责这个输出的文件是 <code>/etc/update-motd.d/10-armbian-header</code>, 不过我不打算改~</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>阅读其它文章</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://horizonchaser.github.io/neo/posts/opai-linux-oled/><span class=button__icon>←</span>
<span class=button__text>嵌入式 Linux 外设 [Part 2] -- 点亮屏幕</span></a></span>
<span class="button next"><a href=https://horizonchaser.github.io/neo/posts/%E4%BD%A0%E5%A5%BD-%E4%B8%96%E7%95%8C/><span class=button__text>你好 世界</span>
<span class=button__icon>→</span></a></span></div></div><script src=https://giscus.app/client.js data-repo=HorizonChaser/neo data-repo-id=R_kgDOLDDwZQ data-category=Announcements data-category-id=DIC_kwDOLDDwZc4CcVGj data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></div><footer class=footer><div class=footer__inner><a href=/neo class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>Horizon Blog Neo</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span><a href=https://github.com/panr/hugo-theme-hello-friend target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div><div><span><center><a href="https://icp.gov.moe/?keyword=20243141" target=_blank>萌ICP备20243141号</a></center></span></div></footer><script type=text/javascript src=/neo/bundle.min.js></script></div></body></html>